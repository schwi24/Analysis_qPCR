---
title: "Analysis of qPCR data"
author: "Christoph Schweingruber"
date: "1/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)

Plate_96 <- tibble(
  Row = replicate(12, LETTERS[1:8]) %>% as.vector(.),
  Column = t(replicate(8, 1:12)) %>% as.vector(.)
) %>% 
  mutate(., Well = str_c(Row, Column, sep = "")) %>%
  arrange(., Row, Column) %>%
  mutate(., Well_Number = 1:96)

Plate_384 <- tibble(
  Row = replicate(24, LETTERS[1:16]) %>% as.vector(.),
  Column = t(replicate(16, 1:24)) %>% as.vector(.)
) %>% 
  mutate(., Well = str_c(Row, Column, sep = "")) %>%
  arrange(., Row, Column) %>%
  mutate(., Well_Number = 1:384)

```

# Introduction

The goal of this file is to create a useful template for the analysis of quantitative real-time PCR data.

To this end, we will re-analyze some old dataset in which different neuronal nuclei in mice were screened for SMN expression.

# Loading data

We have the data tables from each run exported as `.csv` files. This is loaded into `R`:
```{r data}
## Files
data_files <- list.files(
  path = "data", pattern = "\\d.csv", all.files = FALSE, full.names = FALSE,
  recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE
)

## Read in files
data <- data_files %>%
  map_df(
    .x = .,
    .f = ~ read_csv(
      file = file.path("data", .),
      ## Skip over header of file (15 lines) and of data table (1 line).
      skip = 15L,
      ## Keep filename as "Run".
      id = "Run",
      ## Rename columns.
      col_names = c(
        "Well", "Sample_Name", "Detector", "Task", "CT", "Std_CT", "Quantity", 
        "Mean_Quantity", "Std_Quantity", "Filtered", "Melting_Temp"
      ),
      ## CT values as character because of sporadic "Undetermined" value.
      col_types = "ccffcnnnnnn"
    )
  ) %>%
  mutate(., CT = recode(.x = CT, !!!c("Undetermined" = "45.01"))) %>%
  mutate(., CT = as.numeric(CT)) %>%
  mutate(., Run = str_replace(Run, "^data/", ""))
```

We can extract the detectors/assays from the data.
```{r assays}
## Extract the assays/detectors
assays <- data %>%
  select(., Detector) %>%
  unique(.)
```

We want to incorporate the meta data for the analysis, e.g. the tissue information.
```{r meta}
samples <- read_excel(
  file.path("data", "Samples.xlsx"),
  col_names = c("Well", "Sample", "Tissue"),
  skip = 1L
) %>%
  unique(.) %>%
  mutate(
    .,
    Row = str_extract(Well, "[:alpha:]"),
    Column = as.numeric(str_extract(Well, "[0-9][0-9]|[0-9]")),
    .before = Sample
  ) %>%
  mutate(
    .,
    Tissue = factor(
      Tissue,
      levels = c("CN3/4", "CN7", "CN10", "CN12", "RN", "SC", "water")
    )
  ) %>%
  arrange(., Column, Row)

## Merge meta info with data
data <- left_join(data, samples, by = "Well")
```

# CT-sample plots

Investigating the data in unprocessed form is always helpful. We first check the CT values for all samples to spot outliers or "weird" samples.
This also helps us to compare all samples quickly with the PCR controls, e.g. water sample or 'minus-RT' samples.

```{r plot_ct_sample, warning=FALSE, echo=FALSE}
data %>%
  arrange(., Detector, Tissue, desc(Sample)) %>%
  ggplot(
    data = .,
    aes(x = CT, y = Sample, color = Detector)
  ) +
    facet_wrap(
      facets = ~ Tissue,
      dir = "v",
      ncol = 1,
      strip.position = "left",
      scales = "free_y"
    ) +
    geom_vline(xintercept = 5, linetype="dotted") +
    geom_vline(xintercept = 45, linetype="dotted") +
    geom_point() +
    lims(x = c(0, 46)) +
    labs(title = "CT-Sample plot", tag = "A") +
    theme(plot.title = element_text(hjust = 0.5))

data %>%
  arrange(., Detector, Tissue, desc(Sample)) %>%
  ggplot(
    data = .,
    aes(x = CT, y = Sample, color = Detector)
  ) +
    facet_wrap(
      facets = ~ Tissue,
      dir = "v",
      ncol = 1,
      strip.position = "left",
      scales = "free_y"
    ) +
    geom_vline(xintercept = 5, linetype="dotted") +
    geom_vline(xintercept = 45, linetype="dotted") +
    geom_point(alpha = 0.3, position = "jitter") +
    stat_summary(
      fun.data = "mean_sdl",
      geom = "pointrange",
      fun.args = list(mult = 1),
      shape = 1,
      position = "jitter"
    ) +
    lims(x = c(0, 46)) +
    labs(title = "CT-Sample plot", tag = "B") +
    theme(plot.title = element_text(hjust = 0.5))
```

```{r include=FALSE}
## No control over strip.position in facet
data %>%
  arrange(., Detector, Tissue, desc(Sample)) %>%
  ggplot(
    data = .,
    aes(x = CT, y = Sample, color = Detector)
  ) +
    facet_grid(rows = vars(Tissue), scales = "free_y") +
    geom_point() +
    lims(x = c(0, 46)) +
    labs(title = "CT-Sample plot", tag = "A") +
    theme(plot.title = element_text(hjust = 0.5))
```

We can already see some issues with two of the assays in the data set:

* The 'SMN2 tot' assay detects something in the water control as strong as or even stronger than in the samples.
* The 'SMN2 FL' assay varies a lot and sporadically fails to detects something below the detection limit (at cycle = 45).

# Inspect positions

Next we want to make sure that the problems are not bound to specific positions on the PCR plates.

```{r plot_plate_layout, warning=FALSE, echo=FALSE}
data %>%
  mutate(
    .,
    Column = as.integer(Column),
    Row = factor(Row, levels = LETTERS[8:1]),
  ) %>%
  arrange(., Column, Row) %>%
  ggplot(
    data = .,
    aes(x = Column, y = Row, fill = Detector)
  ) +
    facet_wrap(
      facets = ~ Run,
      dir = "v",
      ncol = 1
    ) +
    geom_point() +
    geom_point(color = "Black", shape = 21) +
    geom_text(
      aes(label = Sample, color = Tissue),
      hjust = "left",
      size = 2,
      position = position_nudge(x = 0.1)
    ) +
    scale_x_continuous(labels = waiver(), breaks = 1L:12L) +
    labs(title = "Plate Layout", tag = "A") +
    theme(plot.title = element_text(hjust = 0.5))

data %>%
  mutate(
    .,
    Column = as.integer(Column),
    Row = factor(Row, levels = LETTERS[8:1]),
  ) %>%
  arrange(., Column, Row) %>%
  ggplot(
    data = .,
    aes(x = Column, y = Row, fill = CT)
  ) +
    facet_wrap(
      facets = ~ Run,
      dir = "v",
      ncol = 1
    ) +
    geom_point() +
    scale_fill_gradient(
      low = "Yellow",
      high = "Black",
      na.value = "grey50",
      limits = c(0, 45)
    ) +
    geom_point(color = "Black", shape = 21, size = 2) +
    scale_x_continuous(labels = waiver(), breaks = 1L:12L) +
    labs(title = "Plate Positions", tag = "B") +
    theme(plot.title = element_text(hjust = 0.5))


```

```{r plot_plate_tiles, echo=FALSE, warning=FALSE, include=FALSE}
data %>%
  mutate(
    .,
    Column = as.integer(Column),
    Row = factor(Row, levels = LETTERS[8:1]),
  ) %>%
  arrange(., Column, Row) %>%
  ggplot(
    data = .,
    aes(x = Column, y = Row, fill = Detector)
  ) +
    facet_wrap(
      facets = ~ Run,
      dir = "v",
      ncol = 1
    ) +
    geom_tile(color = "Black", size = 0.4) +
    geom_text(
      aes(label = Sample),
      color = "Black",
      size = 2,
      position = "identity"
    ) +
    scale_x_continuous(labels = waiver(), breaks = 1L:12L) +
    labs(title = "Plate Layout", tag = "B") +
    theme(plot.title = element_text(hjust = 0.5))

data %>%
  mutate(
    .,
    Column = as.integer(Column),
    Row = factor(Row, levels = LETTERS[8:1]),
  ) %>%
  arrange(., Column, Row) %>%
  ggplot(
    data = .,
    aes(x = Column, y = Row, fill = Tissue)
  ) +
    facet_wrap(
      facets = ~ Run,
      dir = "v",
      ncol = 1
    ) +
    geom_tile(color = "Black", size = 0.4) +
    geom_text(
      aes(label = Sample),
      color = "Black",
      size = 2,
      position = "identity"
    ) +
    scale_x_continuous(labels = waiver(), breaks = 1L:12L) +
    labs(title = "Plate Layout", tag = "A") +
    theme(plot.title = element_text(hjust = 0.5))

data %>%
  mutate(
    .,
    Column = as.integer(Column),
    Row = factor(Row, levels = LETTERS[8:1]),
  ) %>%
  arrange(., Column, Row) %>%
  ggplot(
    data = .,
    aes(x = Column, y = Row, fill = CT)
  ) +
    facet_wrap(
      facets = ~ Run,
      dir = "v",
      ncol = 1
    ) +
    geom_tile(color = "Black", size = 0.4) +
    scale_fill_gradient(
      low = "Yellow",
      high = "Black",
      na.value = "grey50",
      limits = c(0, 45)
    ) +
    geom_text(
      aes(label = Sample),
      color = "White",
      size = 2,
      position = "identity"
    ) +
    scale_x_continuous(labels = waiver(), breaks = 1L:12L) +
    labs(title = "Plate Positions", tag = "C") +
    theme(plot.title = element_text(hjust = 0.5))
```

It doesn't look like the plate position is responsible for the problems.

# Melting curves

For SYBR Green assays, it is customary to assess the PCR products by melting analysis.
This is sensitive enough to distinguish even few basepair differences in product length.

```{r load_melt, include=FALSE}
melt_files <- list.files(
  path = "data", pattern = "\\d_melt.csv", all.files = FALSE, full.names = FALSE,
  recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE
)

assay_positions <- function(file_name){
  # Extract the detectors and their positions.
  first <- readLines(con = file.path("data", file_name), n = 1000)
  assays_pos <- str_which(first, "^Detector")
  assays_name <- first[assays_pos] %>%
    str_replace(., "^Detector = ", "") %>%
    str_sub(
     .,
      start = 1,
      end = str_locate(., "Reporter = ")[,1] - 2
    )
  bind_rows(
    tibble(Detector = assays_name, Position = assays_pos),
    tibble(Detector = NULL, Position = length(first) + 1)
  ) %>%
    mutate(
      .,
      Length = (lead(Position)-Position - 4)/3
    ) %>%
    drop_na(.)
}

read_melt <- function(file_name, plate = "Plate_96") {
  # read a '.csv' file with melting data.
  
  # Dependencies
  require(tidyverse)
  
  # Initializations
  plt <- tibble(Plate = c("Plate_96", "Plate_384"), Value = 1:2) %>%
    filter(., Plate == plate) %>%
    select(., Value) %>%
    pull(.)
  variables <- c("Temperature", "Raw_Fluorescence", "Derivative")
  assay_pos <- assay_positions(file_name = file_name)
  melt_tbl <- tibble(NULL)
  
  # Loop over assays (outer) and variables (inner)
  for (i in 1:dim(assay_pos)[1]) {
    
    assay_i <- assay_pos[i,]
    detector_i <- assay_i %>% select(., Detector) %>% pull(.)
    
    for (j in 1:3) {
    
      n_max <- assay_i %>%
        select(., Length) %>%
        pull(.)
      
      skip <- assay_i %>%
        select(., Position) %>%
        pull(.) %>%
        .[] + (j-1) * (n_max + 1) + 1
      
      melt_tbl <- bind_rows(
        melt_tbl,
        read_csv(
          file = file.path("data", file_name),
          skip = skip ,
          n_max = n_max,
          id = "Run",
          col_names = c("Well_Number", paste("x", 1:100, sep = "_")),
          col_types = "idddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd",
          show_col_types = FALSE
        ) %>%
          mutate(., Detector = detector_i, Variable = variables[j]) %>%
          mutate(., Run = str_replace(Run, "^data/", "")) %>%
          pivot_longer(
            data = .,
            cols = starts_with("x_"),
            names_to = "Step",
            names_prefix = "x_",
            values_to = "Value"
          )
      )
    
    }
  }

  melt_tbl <- melt_tbl %>%
    pivot_wider(
      data = .,
      names_from = "Variable",
      values_from = "Value"
    ) %>%
    left_join(
      .,
      switch(plt, Plate_96, Plate_384),
      by = c("Well_Number"="Well_Number"),
      keep = FALSE
    ) %>%
    select(
      .,
      c(
        "Run", "Well", "Row", "Column", "Detector", "Step", "Temperature",
        "Raw_Fluorescence", "Derivative"
      )
    )
  
  return(melt_tbl)

}

melt_data <- melt_files %>%
  map_df(.x = ., .f = ~ read_melt(file_name = .)) 

#melt_data
#melt_data %>% select(., Run) %>% unique(.)
#melt_data %>% select(., Run) %>% is.na(.) %>% any(.)
```

```{r plot_melt, warning=FALSE, echo=FALSE}
melt_data %>%
  group_by(., Run, Well, Detector) %>%
  ggplot(data = ., aes(x = Temperature, y = Derivative, color = Detector, group = Well)) +
    geom_line(alpha = 0.4) +
    facet_grid(facets = (Run ~ Detector)) +
    labs(y = "Fluorescence change, dF/dT", title = "Melting Curves", tag = "") +
    theme(plot.title = element_text(hjust = 0.5))
```

In the melting curves, it becomes clear that the many wells in the 'SMN2 FL' assay
amplified PCR artefacts (peak at lower temperature). In the other assays, there is a similar peak at lower temperatures only for the water control (as to be expected).




